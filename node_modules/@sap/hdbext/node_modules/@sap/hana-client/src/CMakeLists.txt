INCLUDE(buildtools/Preprocessing)

IF(CLIENT_BUILD_NODE)

IF(DARWIN)
    IF(CPP_ABI STREQUAL "xcode7")
         STRING_APPEND(CMAKE_CXX_FLAGS "-std=c++11 -stdlib=libc++")
#        STRING_APPEND(CMAKE_CXX_FLAGS "-std=c++11")
    ELSE() # presume newer
        STRING_APPEND(CMAKE_CXX_FLAGS "-std=c++11")
    ENDIF()
    STRING_APPEND(CMAKE_SHARED_LINKER_FLAGS "-Wl,-undefined,dynamic_lookup")
ELSEIF(LINUX)
    STRING_APPEND(CMAKE_CXX_FLAGS "-std=c++11")
ELSEIF(WINDOWS)
    STRING_APPEND(CMAKE_SHARED_LINKER_FLAGS "-FORCE")
ENDIF()


# ------- Node shim DLL generation ----------
# MESSAGE(STATUS "INTERFACES_SRC_PATH=${INTERFACES_SRC_PATH}")
# MESSAGE(STATUS "CMAKE_SOURCE_DIR=${CMAKE_SOURCE_DIR}")

SET(hananode_sources
    hana.cpp
    utils.cpp
    connection.cpp
    resultset.cpp
    statement.cpp
    ${CMAKE_SOURCE_DIR}/Interfaces/dbcapi/DBCAPI_DLL.cpp
)

# ----------------------------------- Node 4 -----------------------------------
SET(tgt_node4 "hana-client_v4")
ADD_HDB_LIBRARY(${tgt_node4}
                SHARED
                NO_LIB_PREFIX
                ALLOW_UNDEFINED_SYMBOLS_AT_LINK_TIME
                ${hananode_sources})

TARGET_COMPILE_DEFINITIONS(${tgt_node4} PRIVATE
    "_DBCAPI_VERSION=2"
    "DRIVER_NAME=hana"
)

TARGET_INCLUDE_DIRECTORIES( ${tgt_node4} PUBLIC ${CMAKE_SOURCE_DIR}/include/node/node4)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node4} PUBLIC ${CMAKE_SOURCE_DIR}/Interfaces/dbcapi)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node4} PUBLIC "h")

# TARGET_LINK_LIBRARIES(${tgt_node4}
#     PRIVATE
# )

IF(LINUX)
    SET_PROPERTY(TARGET ${tgt_node4} APPEND PROPERTY LINK_FLAGS "-Wl,-Bsymbolic")
ENDIF()
SET_TARGET_PROPERTIES(${tgt_node4} PROPERTIES SUFFIX ".node")

# --------------------------------- End Node 4 ---------------------------------

# ----------------------------------- Node 6 -----------------------------------
SET(tgt_node6 "hana-client")
ADD_HDB_LIBRARY(${tgt_node6}
                SHARED
                NO_LIB_PREFIX
                ALLOW_UNDEFINED_SYMBOLS_AT_LINK_TIME
                ${hananode_sources})

TARGET_COMPILE_DEFINITIONS(${tgt_node6} PRIVATE
    "_DBCAPI_VERSION=2"
    "DRIVER_NAME=hana"
)

TARGET_INCLUDE_DIRECTORIES( ${tgt_node6} PUBLIC ${CMAKE_SOURCE_DIR}/include/node/node6)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node6} PUBLIC ${CMAKE_SOURCE_DIR}/Interfaces/dbcapi)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node6} PUBLIC h)

# TARGET_LINK_LIBRARIES(${tgt_node6}
#     PRIVATE
# )

IF(LINUX)
    SET_PROPERTY(TARGET ${tgt_node6} APPEND PROPERTY LINK_FLAGS "-Wl,-Bsymbolic")
ENDIF()
SET_TARGET_PROPERTIES(${tgt_node6} PROPERTIES SUFFIX ".node")

# --------------------------------- End Node 6 ---------------------------------


# ----------------------------------- Node 8 -----------------------------------
SET(tgt_node8 "hana-client_v8")
ADD_HDB_LIBRARY(${tgt_node8}
                SHARED
                NO_LIB_PREFIX
                ALLOW_UNDEFINED_SYMBOLS_AT_LINK_TIME
                ${hananode_sources})

TARGET_COMPILE_DEFINITIONS(${tgt_node8} PRIVATE
    "_DBCAPI_VERSION=2"
    "DRIVER_NAME=hana"
)

TARGET_INCLUDE_DIRECTORIES( ${tgt_node8} PUBLIC ${CMAKE_SOURCE_DIR}/include/node/node8)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node8} PUBLIC ${CMAKE_SOURCE_DIR}/Interfaces/dbcapi)
TARGET_INCLUDE_DIRECTORIES( ${tgt_node8} PUBLIC "h")

# TARGET_LINK_LIBRARIES(${tgt_node8}
#    PRIVATE
# )

IF(LINUX)
    SET_PROPERTY(TARGET ${tgt_node8} APPEND PROPERTY LINK_FLAGS "-Wl,-Bsymbolic")
ENDIF()
SET_TARGET_PROPERTIES(${tgt_node8} PROPERTIES SUFFIX ".node")

# --------------------------------- End Node 8 ---------------------------------


ELSEIF(CLIENT_BUILD_NODE_SHIM)
    IF(LINUX)
        SET(node_gcc48ongcc43_ok_file "node_gcc48ongcc43.ok")
        SET(gcc48_profile ${PLATFORM_NAME}-gcc48-${EXT_LIB_MODE})
        ADD_CUSTOM_COMMAND(OUTPUT ${node_gcc48ongcc43_ok_file}
            COMMAND ${HAPPY_MAKE_EXECUTABLE} init -b ${gcc48_profile}
            COMMAND ${HAPPY_MAKE_EXECUTABLE} b -b ${gcc48_profile} hana-client_v4 hana-client hana-client_v8
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${gcc48_profile}/gen/hana-client.node ${GEN_DIR}/hana-client.node
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${gcc48_profile}/gen/hana-client_v4.node ${GEN_DIR}/hana-client_v4.node
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${gcc48_profile}/gen/hana-client_v8.node ${GEN_DIR}/hana-client_v8.node
            COMMAND ${CMAKE_COMMAND} -E touch ${node_gcc48ongcc43_ok_file}
        )
        ADD_CUSTOM_TARGET(node_gcc48ongcc43 DEPENDS ${node_gcc48ongcc43_ok_file})
        ADD_DEPENDENCIES(installer node_gcc48ongcc43)
        ADD_DEPENDENCIES(installer_ccl node_gcc48ongcc43)
    ELSEIF(WINDOWS)
        SET(node_msvc2015onmsvc2010_ok_file "node_msvc2015onmsvc2010.ok")
        SET(msvc2015_profile ${PLATFORM_NAME}-msvc2015-${EXT_LIB_MODE})
        ADD_CUSTOM_COMMAND(OUTPUT ${node_msvc2015onmsvc2010_ok_file}
            COMMAND ${HAPPY_MAKE_EXECUTABLE} init -b ${msvc2015_profile}
            COMMAND ${HAPPY_MAKE_EXECUTABLE} b -b ${msvc2015_profile} hana-client_v4 hana-client hana-client_v8
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${msvc2015_profile}/gen/hana-client.node ${GEN_DIR}/hana-client.node
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${msvc2015_profile}/gen/hana-client_v4.node ${GEN_DIR}/hana-client_v4.node
            COMMAND ${CMAKE_COMMAND} -E copy ${INTERFACES_SRC_PATH}/build/${msvc2015_profile}/gen/hana-client_v8.node ${GEN_DIR}/hana-client_v8.node
            COMMAND ${CMAKE_COMMAND} -E touch ${node_msvc2015onmsvc2010_ok_file}
        )
        ADD_CUSTOM_TARGET(node_msvc2015onmsvc2010 DEPENDS ${node_msvc2015onmsvc2010_ok_file})
        ADD_DEPENDENCIES(installer node_msvc2015onmsvc2010)
        ADD_DEPENDENCIES(installer_ccl node_msvc2015onmsvc2010)
    ENDIF()
ENDIF()
